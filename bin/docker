#!/bin/bash

usage() {
  echo "
Usage: ${0##*/} [command]
Commands:
    run     Start all specify docker containers.
    stop    Stop all docker containers.
            Not yet implement stop by name
"
  exit 1
}

compose() {
  compose="docker-compose"
  PARAMS=$@

  for SERVICE in ${PARAMS}; do
    compose+=" -f $ENVROOT/etc/docker/$SERVICE"
    if [[ ${SERVICE} != *".yaml"* ]]; then
      compose+=".yaml"
    fi
  done

  compose+=" up"
  echo "$compose"
}

command() {
  PARAMS=$@

  if [[ -n "$PARAMS" ]]; then
    FILTER=""
    for SERVICE in ${PARAMS}; do
      FILTER+="-e $SERVICE.*yaml "
    done

    SERVICES=$(ls -p $ENVROOT/etc/docker | grep ${FILTER})
  fi

  COMMAND=""
  if [[ "$SERVICES" == "all" ]]; then
    COMMAND="$(compose $(ls -p $ENVROOT/etc/docker | grep -v /))"
  else
    COMMAND="$(compose "$SERVICES")"
  fi

  echo ${COMMAND}
  ${COMMAND}
}

while [ "$1" != "" ]; do
    case $1 in
        run )           shift
                        command $@
                        exit
                        ;;
        stop )          shift
                        docker stop `docker ps --format "{{.Names}}" | grep "work"`
                        exit
                        ;;
        -h | --help )   usage
                        exit
                        ;;
        * )             usage
                        exit 1
    esac
    shift
done
