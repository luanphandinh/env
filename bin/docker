#!/usr/bin/env bash

set -e
export __docker_path__=$__var_lib_dir__/docker/$__profile__
export __docker_service_prefix__="cli_${__profile__}"

usage() {
	echo "
usage: ${0##*/} [command]
commands:

    run     Start all specify docker containers.
            eg: docker run mysql adminer

            Options:

            [--like]    To run services that contain keyword
                        eg: docker run --like sql

    stop    Stop all docker containers.
            Not yet implement stop by name.

    clean   Clean up all docker containers within namespace (default is work_<ENV>).

            Options:

            [--cache]       To remove cache.
"
	exit 1
}

compose() {
	compose="docker-compose"
	PARAMS=$@

	for SERVICE in ${PARAMS}; do
		compose+=" -f $ENVROOT/etc/docker/$SERVICE"
		if [[ ${SERVICE} != *".yaml"* ]]; then
			compose+=".yaml"
		fi
	done

	compose+=" up"
	echo "$compose"
}

run() {
	if [[ "$1" == "all" ]]; then
		COMMAND="$(compose $(ls -p $ENVROOT/etc/docker | grep -v /))"
	else
		SERVICES=$@
		if [[ "$1" == "--like" ]]; then
			PARAMS=$@

			if [[ -n "$PARAMS" ]]; then
				FILTER=""
				for SERVICE in ${PARAMS}; do
					FILTER+="-e $SERVICE.*yaml "
				done

				SERVICES=$(ls -p $ENVROOT/etc/docker | grep ${FILTER})
			fi
		fi
		COMMAND="$(compose "$SERVICES")"
	fi

	$__log__ -i ${COMMAND}
	${COMMAND}
}

stop() {
	$__log__ -i stopped: $(docker stop $(docker ps --format "{{.Names}}" | grep "${__docker_service_prefix__}"))
}

clean() {
	if [ $(docker ps -a --format "{{.Names}}" | grep "$__docker_service_prefix__" | wc -l) -gt 0 ]; then
		$__log__ -i "docker clean up images."
		$__log__ -i cleaned: $(docker rm $(docker ps -a --format "{{.Names}}" | grep "$__docker_service_prefix__"))
		$__log__ -i "docker clean up images done."
	fi

	if [ "$1" == "--cache" ]; then
		$__log__ -i "docker clean up images cache."
		rm -rf "$__docker_path__"
		$__log__ -i "docker clean up images cache done."
	fi
}

while [ "$1" != "" ]; do
	case $1 in
	run)
		shift
		if [ ! -d "$__docker_path__" ]; then
			mkdir $__docker_path__
		fi
		$__log__ -i "docker runs: $@"
		run $@
		exit
		;;
	stop)
		shift
		$__log__ -i "docker stop."
		stop
		exit
		;;
	clean)
		shift
		clean $1
		exit
		;;
	-h | --help)
		usage
		exit
		;;
	*)
		usage
		exit 1
		;;
	esac
	shift
done
